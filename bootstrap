#! /bin/sh

set -ex

srcdir="$(dirname "$0")"
test -z "$srcdir" && srcdir=.

cd "$srcdir"

[ -d cross-detect ] || git clone https://github.com/mintsuki/cross-detect.git
[ -d freestanding-headers ] || git clone https://github.com/mintsuki/freestanding-headers.git
[ -d stivale ] || git clone https://github.com/stivale/stivale.git
[ -d limine-efi ] || git clone https://github.com/limine-bootloader/limine-efi.git

if ! [ -d libgcc-binaries ]; then
    git clone https://github.com/mintsuki/libgcc-binaries.git

    # Remove the libgcc files we don't need
    libgcc_needed="i686 x86_64-no-red-zone"
    for f in $libgcc_needed; do
        mv libgcc-binaries/libgcc-$f.a libgcc-binaries/libgcc-$f.a.save
    done
    rm libgcc-binaries/*.a
    for f in $libgcc_needed; do
        mv libgcc-binaries/libgcc-$f.a.save libgcc-binaries/libgcc-$f.a
    done
fi

automake_libdir="$(automake --print-libdir)"

mkdir -p build-aux
cp "${automake_libdir}/install-sh" build-aux

autoreconf -fvi
